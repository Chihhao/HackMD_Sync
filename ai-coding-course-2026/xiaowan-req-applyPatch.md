# AI 小旺功能需求：一鍵套用 (Apply Patch) 實作建議書

## 1. 背景與目標
目前「AI 小旺」在 Coding 模式下，使用者需手動複製 AI 生成的程式碼並貼回 IDE，流程繁瑣且容易出錯。本需求旨在模擬現代 AI IDE (如 Cursor) 的體驗，讓使用者能在網頁上直接預覽變更，並一鍵將修改套用至本機檔案。

## 2. 核心技術架構

### 2.1 檔案存取權限 (File System Access API)
由於公司環境限制使用 HTTP，需透過「AI 小旺啟動器」帶入特定參數開啟 Chrome，以啟用安全 API：
- **啟動參數**: `--unsafely-treat-insecure-origin-as-secure="http://your-internal-url"`
- **API 呼叫**: 改用 `window.showDirectoryPicker()` 取代傳統的 `<input type="file">`，取得目錄的 `FileSystemDirectoryHandle` 以獲得持久化的讀寫權限。

### 2.2 差異格式規範 (Unified Diff)
為了精準修改大型檔案（如 TE 萬行測試程式）並節省 Token，強制要求 AI 輸出 **Unified Diff** 格式：
- **優點**: 僅傳輸變更部分、具備上下文錨點 (Context Lines) 供精準定位、支援多處同時修改。
- **System Prompt 要求 (條件式觸發)**: 
  - **觸發時機**: 僅在「Coding 模式」開啟時注入。非 Coding 模式（如一般對話）則維持標準輸出，避免干擾一般使用者。
  > 「請針對修改點輸出 ```diff 格式區塊。必須包含 --- 與 +++ 標頭（含完整路徑），並提供至少 6 行上下文以利精準定位。」

## 3. 前端 UI/UX 設計

### 3.1 差異渲染 (Diff Rendering)
- **組件化**: 攔截 Markdown 中的 `diff` 代碼塊，轉換為視覺化組件。
- **視覺風格**: 
  - 刪除行：紅色背景 (`-`)
  - 新增行：綠色背景 (`+`)
  - 上下文：預設背景
- **互動按鈕**: 每個 Diff 區塊右上角配置「套用 (Apply)」與「拒絕 (Reject)」按鈕。

### 3.2 多區塊管理
- 一則對話中若有多個變更，需追蹤每個區塊的狀態（待處理、已套用、套用失敗）。
- 套用後應鎖定按鈕，避免重複寫入。

### 3.3 復原機制 (Undo Mechanism)
- 在點擊「套用」後，UI 應提供短暫的「復原」按鈕。
- **實作方式**: 在執行寫入前，將原始檔案內容暫存於記憶體中。若使用者點擊復原，則將暫存內容重新寫回檔案。這能大幅降低使用者對 AI 亂改程式碼的恐懼感。

## 4. 實作邏輯流程

0. **動態 Prompt 注入**: 偵測 Coding 模式開關狀態，決定是否附加 Diff 規範指令至發送給 AI 的 System Prompt 中。
   - **中途切換處理 (Context Pivot)**: 
     - 若使用者在對話中途開啟 Coding 模式，系統應在下一則發送的訊息前，自動注入一則隱藏的「格式轉折指令」，不要顯示在 UI 上。
     - **指令範例**: `[系統通知: 使用者已開啟 Coding 模式。從現在起，若涉及程式碼修改，請嚴格遵守 Unified Diff 格式規範，並包含完整的檔案路徑與足夠的上下文。]`
     - 這樣可以有效打破 AI 的輸出慣性，確保格式立即生效。

1. **解析**: 從 Diff 標頭提取檔案路徑。
2. **讀取**: 透過 `FileSystemDirectoryHandle` 取得原始檔案內容字串。
3. **比對與 Patch**: 
   - **預檢 (Dry Run)**: 在正式寫入前先執行 `applyPatch`。
   - **失敗處理**: 若回傳 `false`，代表檔案內容已變動或 AI 提供的上下文不匹配。UI 應顯示衝突原因，並提供「重新生成建議」按鈕，自動將最新檔案內容再次送出。
   - **Fuzzy Matching**: 由於 AI 計算行號常有誤差，應實作基於上下文內容的搜尋演算法，而非僅依賴行號。
   - **語法預檢**: 套用後在記憶體中進行初步語法掃描（如括號匹配），若有明顯錯誤需即時提示。
4. **寫入**: 
   - 若 Patch 成功，透過 `FileSystemWritableFileStream` 覆蓋原檔案。
   - 若 Patch 失敗（上下文不匹配），提示使用者手動介入。
5. **備份**: 寫入前建議先將原內容暫存於記憶體或建立 `.bak` 檔。

## 5. 針對 TE 環境的特殊優化

- **大型檔案處理**: 由於 TE 程式碼重複性高，上下文 (Context Lines) 必須足夠長（建議 6-10 行）以避免定位到錯誤的暫存器操作區塊。
- **安全性 (二次確認)**: 針對涉及硬體控制的關鍵字（如 `WriteRegister`, `Relay`, `Voltage`, `Power_On`），系統應在 Diff 預覽中以黃色高亮顯示該區塊。點擊「套用」時需彈出二次確認視窗，強制工程師人工審核硬體時序與參數，降低損壞 DUT 的風險。
- **變更日誌 (Audit Log)**: 每次成功套用 Patch 後，系統應自動記錄變更時間、檔案與 Diff 內容於本地資料庫，以便在硬體測試異常時進行回溯分析。

## 6. 推薦工具清單

| 功能 | 推薦函式庫 | 說明 |
| :--- | :--- | :--- |
| **Diff 解析與套用** | jsdiff | 穩定且支援 `applyPatch` 功能。 |
| **視覺化渲染** | diff2html | 支援 Side-by-side 或 Line-by-line 預覽。 |
| **Markdown 渲染** | markdown-it | 易於擴充自定義代碼塊渲染邏輯。 |

## 7. 開發潛在坑位 (Potential Pitfalls)

### 7.1 換行符號 (CRLF vs LF)
- **問題**: Windows 環境（TE 常見）多使用 `\r\n`，但 AI 輸出的 Diff 往往預設使用 `\n`。
- **影響**: `jsdiff` 的 `applyPatch` 對空白字元極度敏感，換行符不一致會導致 Patch 失敗。
- **對策**: 在執行 Patch 前，先將原始檔案內容與 Diff 內容的換行符進行統一化處理（例如全部轉為 `\n`），寫入時再根據專案規範還原。

### 7.2 權限持久化 (Permission Persistence)
- **問題**: 即使使用了 `--user-data-dir`，瀏覽器基於安全考量，在每次重新啟動後仍可能要求使用者重新點擊「允許」讀寫權限。
- **對策**: 使用 IndexedDB 儲存 `FileSystemDirectoryHandle`。雖然重啟後仍需使用者互動觸發（如點擊按鈕），但可以避免重新彈出資料夾選擇視窗。

### 7.3 路徑不一致 (Path Mismatch)
- **問題**: AI 輸出的路徑可能是 `src/main.cpp`，但使用者掛載的根目錄可能是 `project/`，導致找不到檔案。
- **對策**: 實作簡單的路徑模糊匹配邏輯。若絕對路徑找不到，嘗試在掛載目錄下搜尋檔名相同的檔案。

### 7.4 大檔案效能 (Performance)
- **問題**: 在瀏覽器主執行緒處理上萬行的字串比對與 Patch 會造成 UI 凍結。
- **對策**: 將 `applyPatch` 的邏輯移至 **Web Worker** 執行，確保 UI 渲染（如動畫、打字效果）保持流暢。

### 7.5 編碼問題 (Encoding)
TE 的測試程式有時會包含特殊的編碼（如 Big5 或 UTF-16），而瀏覽器的 FileReader 或 TextDecoder 預設通常是 UTF-8。如果遇到亂碼，Patch 絕對會失敗。建議在讀取檔案時加入簡單的編碼偵測。

### 7.6 原子性寫入 (Atomic Writes)
寫入檔案時，如果中途斷電或瀏覽器崩潰，檔案可能會損壞。雖然在 Web 環境很難做到真正的原子性，但建議先寫入一個臨時檔（如 filename.tmp），確認成功後再更名/覆蓋，這比直接 createWritable 安全得多。

### 7.7 AI 輸出慣性 (Output Inertia)
AI 有時會忽略 System Prompt 的格式要求而直接輸出全檔。前端解析器需具備識別能力，若偵測到非 Diff 格式的程式碼塊，應提供「全檔覆蓋」與「手動比對」的備選方案。

# 里程碑規劃 (Milestones)

### M1: 核心通路驗證 (MVP)
- [ ] 實作 `FileSystemDirectoryHandle` 的持久化儲存與讀取。
- [ ] 建立動態 System Prompt 注入機制，強制 AI 輸出 Unified Diff。
- [ ] 整合 `jsdiff` 基礎解析邏輯，實現最基本的檔案覆蓋寫入。

### M2: 視覺化與互動體驗
- [ ] 實作 Diff 渲染組件（紅/綠背景顯示變更）。
- [ ] 加入「套用/拒絕」按鈕與記憶體級別的「復原 (Undo)」功能。
- [ ] 處理 CRLF/LF 換行符號自動轉換，解決 Windows 環境下的 Patch 失敗問題。

### M3: TE 安全性與魯棒性強化
- [ ] **硬體安全檢查**：實作關鍵字偵測與黃色高亮預警，加入「二次確認」彈窗。
- [ ] **變更追蹤系統**：實作本地 Audit Log，紀錄所有透過 AI 執行的檔案修改。
- [ ] **Fuzzy Matching**：開發基於上下文內容的搜尋演算法，容忍 AI 輸出的行號誤差。
- [ ] **效能優化**：將 Patch 運算移至 Web Worker，避免大型檔案處理時 UI 凍結。

### M4: 極端情境處理與發佈
- [ ] **衝突診斷機制**：當自動 Patch 失敗時，自動分析原因並引導使用者「一鍵重新生成」，而非手動對齊。
- [ ] 完成內部 Beta 測試並正式上線。
